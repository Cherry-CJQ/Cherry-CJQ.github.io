<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<script>
  (function() {
    function initLeanCloud() {
      console.log('LeanCloud: Starting initialization...');
      
      /* Check if AV is defined */
      if (typeof AV === 'undefined') {
        console.error('LeanCloud: AV object is undefined. SDK not loaded.');
        return;
      }

      const appId = '{{ site.leancloud.app_id }}';
      const appKey = '{{ site.leancloud.app_key }}';
      const serverURL = '{{ site.leancloud.app_url }}';

      console.log('LeanCloud: Config - AppID:', appId, 'ServerURL:', serverURL);

      try {
        AV.init({
          appId: appId,
          appKey: appKey,
          serverURL: serverURL
        });
        console.log('LeanCloud: Initialized successfully.');
      } catch (e) {
        console.error('LeanCloud: Initialization failed:', e);
        return;
      }

      const Counter = AV.Object.extend('Counter');

      /* Helper to display count */
      function showCount(elementId, count) {
        const el = document.getElementById(elementId);
        if (el) {
          console.log(`LeanCloud: Updating ${elementId} with count ${count}`);
          el.innerText = count;
        } else {
          console.warn(`LeanCloud: Element ${elementId} not found in DOM.`);
        }
      }

      /* Increment and get Site PV */
      function handleSitePV() {
        console.log('LeanCloud: Handling Site PV...');
        const query = new AV.Query('Counter');
        query.equalTo('url', 'site_pv');
        query.first().then((counter) => {
          if (counter) {
            console.log('LeanCloud: Site PV record found, incrementing...');
            counter.increment('time', 1);
            counter.save().then(() => {
              showCount('site-pv', counter.get('time'));
            });
          } else {
            console.log('LeanCloud: Site PV record not found, creating new...');
            const newCounter = new Counter();
            /* Set ACL for public access */
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newCounter.setACL(acl);
            
            newCounter.set('title', 'Site PV');
            newCounter.set('url', 'site_pv');
            newCounter.set('time', 1);
            newCounter.save().then(() => {
              showCount('site-pv', 1);
            });
          }
        }, (error) => {
          console.error('LeanCloud: Site PV Query Error:', error);
        });
      }

      /* Increment and get Page PV */
      function handlePagePV() {
        /* Only run on pages that have the page-pv element */
        const pagePvEl = document.getElementById('page-pv');
        if (!pagePvEl) {
          console.log('LeanCloud: Page PV element not found (not a post page?)');
          return;
        }

        /* Normalize URL: remove 'index.html', '.html', and trailing slash */
        let url = window.location.pathname;
        url = url.replace(/index\.html$/, '');
        url = url.replace(/\.html$/, '');
        url = url.replace(/\/$/, '');
        /* If root path, keep it as slash or empty string consistent with your logic, 
           but for posts typically it ends with the post slug. 
           Let's just ensure consistent handling. */
        if (url === '') url = '/'; 

        const title = document.title;
        console.log('LeanCloud: Handling Page PV for:', url);

        const query = new AV.Query('Counter');
        query.equalTo('url', url);
        query.first().then((counter) => {
          if (counter) {
            console.log('LeanCloud: Page PV record found, incrementing...');
            counter.increment('time', 1);
            counter.save().then(() => {
              showCount('page-pv', counter.get('time'));
            });
          } else {
            console.log('LeanCloud: Page PV record not found, creating new...');
            const newCounter = new Counter();
            /* Set ACL for public access */
            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newCounter.setACL(acl);

            newCounter.set('title', title);
            newCounter.set('url', url);
            newCounter.set('time', 1);
            newCounter.save().then(() => {
              showCount('page-pv', 1);
            });
          }
        }, (error) => {
          console.error('LeanCloud: Page PV Query Error:', error);
        });
      }

      handleSitePV();
      handlePagePV();
    }

    /* Run on standard load */
    document.addEventListener('DOMContentLoaded', initLeanCloud);
  })();
</script>